from snakemake.utils import min_version
from pathlib import Path

##### set minimum snakemake version #####
min_version("8.8.0")

configfile: "config.yaml"

##### resolve global paths from data_dir #####
base = Path(config["data_dir"])
config["samples"] = str(base / config["samples"])
for k in ("long_reads", "short_reads", "read_qc", "dehost"):
    config["input"][k] = str(base / config["input"][k])

config["reference"]["human"] = str(Path(config["input"]["databases"]) / config["reference"]["human"])
config["reference"]["bacteria"] = str(Path(config["input"]["databases"]) / config["reference"]["bacteria"])


##### samples #####
with open(config["samples"]) as f:
    next(f)  # skip header
    SAMPLES = [line.split()[0] for line in f if line.strip()]

##### entry point #####
rule all:
    input:
        expand(directory(base / config["output"]["binning"]["binning"] / "{sample}_binning" / "maxbin2_bins"), sample=SAMPLES) 
#        expand(str(base / config["output"]["assembly"]["spades"] / "{sample}_assembly" / "contigs.fasta"), sample=SAMPLES) 
#        expand(str(base / config["output"]["qc"]["read_qc"] / "{sample}" / "final_pure_reads_1.fastq"), sample=SAMPLES)
#        expand(str(base / config["output"]["dehost"]["sam"] / "nano.{sample}.dehost.fq.gz"), sample=SAMPLES)

##### load rules #####
#include: "rules/nano_dehost.smk"
#include: "rules/read_qc.smk"
#include: "rules/preassembly.smk"
include: "rules/binning.smk"

